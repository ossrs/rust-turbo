#!/bin/bash

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Colorful print functions
print_info() {
    echo -e "${BLUE}$1${NC}"
}

print_success() {
    echo -e "${GREEN}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}$1${NC}"
}

print_error() {
    echo -e "${RED}$1${NC}"
}

print_info "rust-turbo configure script"
print_info "============================"

# Copy SRS documentation and source code as knowledge base for AI.
function copy_srs_docs() {
    SRS_BASE="../srs/trunk"
    DOC_DIR="doc"

    # Ignore if SRS base not exists.
    if [ ! -d "${SRS_BASE}" ]; then
        return 0
    fi

    # Create doc directory
    mkdir -p "${DOC_DIR}"

    # Remove and copy srs-docs
    if [ -d "${SRS_BASE}/3rdparty/srs-docs" ]; then
        print_info "Copying SRS documentation..."
        rm -rf "${DOC_DIR}/srs-docs" && 
            cp -r "${SRS_BASE}/3rdparty/srs-docs" "${DOC_DIR}/srs-docs" && 
            print_success "OK: ${DOC_DIR}/srs-docs"
        if [ $? -ne 0 ]; then
            print_error "Failed to copy SRS documentation"
            return 1
        fi
    fi

    # Remove and copy srs src
    if [ -d "${SRS_BASE}/src" ]; then
        print_info "Copying SRS source code..."
        rm -rf "${DOC_DIR}/srs-src" && 
            cp -r "${SRS_BASE}/src" "${DOC_DIR}/srs-src" && 
            print_success "OK: ${DOC_DIR}/srs-src"
        if [ $? -ne 0 ]; then
            print_error "Failed to copy SRS source code"
            return 1
        fi
    fi

    return 0
}

copy_srs_docs
if [ $? -ne 0 ]; then
    print_error "Configuration failed!"
    exit 1
fi

# Generate Makefile
function generate_makefile() {
    print_info "Generating Makefile..."

    cat > Makefile << 'EOF'
# Makefile for rust-turbo
# Generated by configure script

.PHONY: build clean

# Build in debug mode (format code first, then build)
build:
	@echo "Formatting code..."
	@cargo fmt
	@echo "Building rust-turbo in debug mode..."
	@cargo build

# Clean build artifacts
clean:
	@echo "Cleaning build artifacts..."
	@cargo clean
EOF

    if [ $? -eq 0 ]; then
        print_success "OK: Makefile generated"
        return 0
    else
        print_error "Failed to generate Makefile"
        return 1
    fi
}

generate_makefile
if [ $? -ne 0 ]; then
    print_error "Configuration failed!"
    exit 1
fi

print_success "Configuration complete!"
print_info ""
print_info "Next steps:"
print_info "  make          - Build in debug mode"
print_info "  make clean    - Clean build artifacts"

